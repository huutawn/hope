<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        input, textarea { padding: 8px; margin: 5px; width: 200px; }
        .messages { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .log { background-color: #f9f9f9; padding: 10px; margin: 5px 0; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Message & Notification Test Client</h1>
        
        <!-- Connection Section -->
        <div class="section">
            <h2>Connection</h2>
            <input type="text" id="token" placeholder="JWT Token" style="width: 400px;">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <div id="connection-status">Disconnected</div>
        </div>

        <!-- Messages Section -->
        <div class="section">
            <h2>Messages</h2>
            <div>
                <input type="text" id="senderEmail" placeholder="Sender Email">
                <input type="text" id="receiverEmail" placeholder="Receiver Email">
                <input type="text" id="messageContent" placeholder="Message Content" style="width: 300px;">
                <button onclick="sendMessage()">Send Message</button>
            </div>
            <div>
                <input type="text" id="roomId" placeholder="Room ID">
                <button onclick="sendRoomMessage()">Send Room Message</button>
            </div>
            <div class="messages" id="messagesList"></div>
        </div>

        <!-- Notifications Section -->
        <div class="section">
            <h2>Notifications</h2>
            <div>
                <input type="text" id="notificationUserEmail" placeholder="User Email">
                <input type="text" id="notificationTitle" placeholder="Title">
                <input type="text" id="notificationMessage" placeholder="Message" style="width: 300px;">
                <input type="text" id="notificationType" placeholder="Type (info/warning/error)">
                <button onclick="sendNotification()">Send Notification</button>
            </div>
            <div>
                <input type="text" id="roleName" placeholder="Role Name">
                <button onclick="sendRoleNotification()">Send to Role</button>
            </div>
            <div>
                <button onclick="broadcastNotification()">Broadcast Notification</button>
            </div>
            <div class="messages" id="notificationsList"></div>
        </div>

        <!-- Logs -->
        <div class="section">
            <h2>Logs</h2>
            <div class="messages" id="logs"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let userEmail = '';

        function log(message) {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            logDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
        }

        function connect() {
            const token = document.getElementById('token').value;
            if (!token) {
                alert('Please enter JWT token');
                return;
            }

            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);
            
            // Set JWT token for authentication
            stompClient.connect(
                { login: token }, // Pass token as login parameter
                function(frame) {
                    log('Connected: ' + frame);
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').style.color = 'green';
                    
                    // Extract user email from token (you might need to decode JWT properly)
                    userEmail = document.getElementById('senderEmail').value || 'test@example.com';
                    
                    // Subscribe to personal message queue
                    stompClient.subscribe('/user/queue/messages', function(message) {
                        const messageObj = JSON.parse(message.body);
                        displayMessage('Received: ' + JSON.stringify(messageObj, null, 2));
                        log('Message received: ' + messageObj.content);
                    });

                    // Subscribe to personal notification queue
                    stompClient.subscribe('/user/queue/notifications', function(notification) {
                        const notificationObj = JSON.parse(notification.body);
                        displayNotification('Received: ' + JSON.stringify(notificationObj, null, 2));
                        log('Notification received: ' + notificationObj.title);
                    });

                    // Subscribe to broadcast notifications
                    stompClient.subscribe('/topic/notifications/broadcast', function(notification) {
                        const notificationObj = JSON.parse(notification.body);
                        displayNotification('Broadcast: ' + JSON.stringify(notificationObj, null, 2));
                        log('Broadcast notification: ' + notificationObj.title);
                    });

                    log('Subscribed to message and notification queues');
                },
                function(error) {
                    log('Connection error: ' + error);
                    document.getElementById('connection-status').textContent = 'Connection Failed';
                    document.getElementById('connection-status').style.color = 'red';
                }
            );
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                log('Disconnected');
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').style.color = 'black';
            }
        }

        function sendMessage() {
            if (!stompClient || !stompClient.connected) {
                alert('Please connect first');
                return;
            }

            const messageRequest = {
                senderEmail: document.getElementById('senderEmail').value,
                receiverEmail: document.getElementById('receiverEmail').value,
                content: document.getElementById('messageContent').value
            };

            stompClient.send('/app/message.send', {}, JSON.stringify(messageRequest));
            displayMessage('Sent: ' + JSON.stringify(messageRequest, null, 2));
            log('Message sent to: ' + messageRequest.receiverEmail);
        }

        function sendRoomMessage() {
            if (!stompClient || !stompClient.connected) {
                alert('Please connect first');
                return;
            }

            const roomId = document.getElementById('roomId').value;
            const messageRequest = {
                senderEmail: document.getElementById('senderEmail').value,
                receiverEmail: '', // Not needed for room messages
                content: document.getElementById('messageContent').value
            };

            // Subscribe to room if not already subscribed
            if (roomId) {
                stompClient.subscribe('/topic/room/' + roomId, function(message) {
                    const messageObj = JSON.parse(message.body);
                    displayMessage('Room [' + roomId + ']: ' + JSON.stringify(messageObj, null, 2));
                    log('Room message received: ' + messageObj.content);
                });

                stompClient.send('/app/message.room.' + roomId, {}, JSON.stringify(messageRequest));
                displayMessage('Sent to room [' + roomId + ']: ' + JSON.stringify(messageRequest, null, 2));
                log('Room message sent to: ' + roomId);
            }
        }

        function sendNotification() {
            if (!stompClient || !stompClient.connected) {
                alert('Please connect first');
                return;
            }

            const notificationRequest = {
                userEmail: document.getElementById('notificationUserEmail').value,
                title: document.getElementById('notificationTitle').value,
                message: document.getElementById('notificationMessage').value,
                type: document.getElementById('notificationType').value || 'info'
            };

            stompClient.send('/app/notification.send', {}, JSON.stringify(notificationRequest));
            displayNotification('Sent: ' + JSON.stringify(notificationRequest, null, 2));
            log('Notification sent to: ' + notificationRequest.userEmail);
        }

        function sendRoleNotification() {
            if (!stompClient || !stompClient.connected) {
                alert('Please connect first');
                return;
            }

            const notificationRequest = {
                roleName: document.getElementById('roleName').value,
                title: document.getElementById('notificationTitle').value,
                message: document.getElementById('notificationMessage').value,
                type: document.getElementById('notificationType').value || 'info'
            };

            stompClient.send('/app/notification.role', {}, JSON.stringify(notificationRequest));
            displayNotification('Sent to role [' + notificationRequest.roleName + ']: ' + JSON.stringify(notificationRequest, null, 2));
            log('Role notification sent to: ' + notificationRequest.roleName);
        }

        function broadcastNotification() {
            if (!stompClient || !stompClient.connected) {
                alert('Please connect first');
                return;
            }

            const notificationRequest = {
                title: document.getElementById('notificationTitle').value,
                message: document.getElementById('notificationMessage').value,
                type: document.getElementById('notificationType').value || 'info'
            };

            stompClient.send('/app/notification.broadcast', {}, JSON.stringify(notificationRequest));
            displayNotification('Broadcast: ' + JSON.stringify(notificationRequest, null, 2));
            log('Broadcast notification sent');
        }

        function displayMessage(content) {
            const messagesList = document.getElementById('messagesList');
            const messageDiv = document.createElement('div');
            messageDiv.style.margin = '5px 0';
            messageDiv.style.padding = '5px';
            messageDiv.style.backgroundColor = '#e7f3ff';
            messageDiv.style.borderLeft = '3px solid #007bff';
            messageDiv.innerHTML = '<pre>' + content + '</pre>';
            messagesList.appendChild(messageDiv);
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function displayNotification(content) {
            const notificationsList = document.getElementById('notificationsList');
            const notificationDiv = document.createElement('div');
            notificationDiv.style.margin = '5px 0';
            notificationDiv.style.padding = '5px';
            notificationDiv.style.backgroundColor = '#fff3cd';
            notificationDiv.style.borderLeft = '3px solid #ffc107';
            notificationDiv.innerHTML = '<pre>' + content + '</pre>';
            notificationsList.appendChild(notificationDiv);
            notificationsList.scrollTop = notificationsList.scrollHeight;
        }

        // Fill some default values
        window.onload = function() {
            document.getElementById('senderEmail').value = 'user1@example.com';
            document.getElementById('receiverEmail').value = 'user2@example.com';
            document.getElementById('messageContent').value = 'Hello WebSocket!';
            document.getElementById('notificationUserEmail').value = 'user2@example.com';
            document.getElementById('notificationTitle').value = 'Test Notification';
            document.getElementById('notificationMessage').value = 'This is a test notification';
            document.getElementById('notificationType').value = 'info';
            document.getElementById('roomId').value = 'room1';
            document.getElementById('roleName').value = 'USER';
        };
    </script>
</body>
</html>
